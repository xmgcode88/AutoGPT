# AutoGPT 后端管理端说明文档

## 项目概述

AutoGPT是一个功能完整的AI Agent平台，包含客户端和管理端两个主要部分。管理端提供了全面的用户管理、内容审核、系统监控和运营分析功能。

## 管理端访问信息

### 访问地址
- **管理端基础路径**: `/admin`
- **主要访问页面**:
  - 管理仪表板: `http://localhost:3000/admin/dashboard`
  - 用户管理: `http://localhost:3000/admin/users`
  - 商店管理: `http://localhost:3000/admin/marketplace`
  - 消费管理: `http://localhost:3000/admin/spending`
  - 用户模拟: `http://localhost:3000/admin/impersonation`
  - 执行分析: `http://localhost:3000/admin/execution-analytics`
  - 管理员设置: `http://localhost:3000/admin/settings`

### 权限要求
- 需要管理员权限才能访问管理端页面
- 非管理员用户访问会被重定向到 `/unauthorized` 页面
- 权限验证文件：`frontend/src/lib/withRoleAccess.ts`

## 核心管理功能

### 1. 用户管理系统

#### 用户信用管理
- **功能位置**: `/admin/users` 和 `/admin/spending`
- **主要功能**:
  - 查看用户列表和详细信息
  - 管理用户信用额度
  - 添加/扣除用户积分
  - 查看用户消费历史记录
  - 搜索和筛选用户

#### 用户模拟功能
- **功能位置**: `/admin/impersonation`
- **主要功能**:
  - 管理员可以模拟其他用户身份
  - 用于用户支持和问题调试
  - 模拟状态下可以查看用户视角的界面
  - 随时可以退出模拟状态

### 2. 通知消息管理系统

#### 通知类型管理
- **系统通知位置**: `backend/backend/notifications/`
- **支持的通知类型**:
  - Agent运行状态通知
  - 模块执行失败警报
  - 连续代理错误警报
  - 商店申请批准/拒绝通知
  - 账户余额通知（零余额、低余额警告）
  - 摘要报告（每日、每周、每月）

#### 通知发送机制
- **邮件服务**: 使用Postmark服务发送邮件
- **队列系统**: RabbitMQ处理通知队列
- **批量处理**: 支持批量发送和延迟发送
- **用户偏好**: 用户可自定义通知接收类型

#### 通知配置位置
- 后端: `backend/backend/notifications/notifications.py`
- 前端: `frontend/src/app/(platform)/profile/(user)/settings/components/NotificationForm/`

### 3. 商店/市场管理系统

#### Agent审核系统
- **功能位置**: `/admin/marketplace`
- **主要功能**:
  - 审核用户提交的Agent
  - 批准或拒绝Agent发布申请
  - 查看Agent版本历史
  - 下载和测试Agent文件
  - 管理Agent分类和标签

#### 审核流程
1. 用户提交Agent到商店
2. 管理员在管理端查看待审核项目
3. 管理员可以下载、测试Agent
4. 做出批准或拒绝决定
5. 系统自动通知用户审核结果

### 4. 菜单和权限管理

#### 动态菜单系统
- **菜单位置**:
  - 主导航: `frontend/src/components/layout/Navbar/`
  - 侧边栏: `frontend/src/components/__legacy__/Sidebar.tsx`
- **功能特性**:
  - 基于用户角色动态显示菜单项
  - 响应式设计适配桌面和移动端
  - 管理员专用菜单项包含所有管理功能

#### 权限控制系统
- **权限验证**: `frontend/src/lib/withRoleAccess.ts`
- **后端权限**: 所有管理API都有 `requires_admin_user` 依赖
- **角色类型**:
  - `admin`: 管理员，拥有所有权限
  - `user`: 普通用户，只能访问个人功能
  - 支持扩展更多角色类型

### 5. 执行分析和监控

#### 系统监控功能
- **功能位置**: `/admin/execution-analytics`
- **监控内容**:
  - Agent执行统计
  - 系统性能指标
  - 错误率和成功率
  - 用户活跃度分析
  - 资源使用情况

#### 错误追踪
- **监控系统**: Sentry集成
- **警报机制**: Discord通知
- **日志管理**: 结构化日志记录

## 技术架构

### 后端架构
- **框架**: Python FastAPI
- **数据库**: PostgreSQL + Prisma ORM
- **消息队列**: RabbitMQ
- **缓存**: Redis
- **邮件服务**: Postmark
- **监控**: Sentry + Discord

### 前端架构
- **框架**: Next.js 15 + React 18 + TypeScript
- **UI组件**: 自定义组件库
- **状态管理**: React Hooks + Context
- **认证**: Supabase + JWT

### 管理端API路由
```
/backend/backend/server/v2/admin/
├── credit_admin_routes.py    # 用户信用管理API
└── store_admin_routes.py     # 商店管理API
```

### 管理端页面结构
```
/frontend/src/app/(platform)/admin/
├── layout.tsx                # 管理端布局
├── dashboard/page.tsx        # 仪表板
├── users/page.tsx            # 用户管理
├── marketplace/page.tsx      # 商店管理
├── spending/page.tsx         # 消费管理
├── impersonation/page.tsx    # 用户模拟
├── execution-analytics/page.tsx # 执行分析
└── settings/page.tsx         # 管理员设置
```

## 部署和配置

### 环境变量配置
管理端需要配置以下关键环境变量：
- `SUPABASE_URL`: Supabase认证服务URL
- `SUPABASE_ANON_KEY`: Supabase匿名密钥
- `POSTMARK_API_TOKEN`: 邮件服务API密钥
- `RABBITMQ_URL`: 消息队列连接地址
- `REDIS_URL`: 缓存服务连接地址

### 启动服务
```bash
# 启动后端服务
cd backend
python -m uvicorn app:app --reload

# 启动前端服务
cd frontend
npm run dev
```

### 默认管理员账户
需要手动在数据库中创建管理员账户，或使用种子数据创建测试管理员用户。

## 安全特性

1. **身份认证**: 基于Supabase的JWT认证
2. **权限控制**: 前后端双重权限验证
3. **API保护**: 所有管理API需要管理员权限
4. **审计日志**: 记录所有管理操作
5. **数据加密**: 敏感数据加密存储

## 扩展功能

管理端设计支持以下扩展：
- 添加新的管理功能模块
- 自定义用户角色和权限
- 集成第三方监控系统
- 添加更多通知渠道
- 扩展审核工作流

## 联系和支持

如有技术问题或功能需求，请联系开发团队或查看项目文档。

---

*最后更新时间: 2025-12-16*

## 启动 Supabase (Docker) 并运行 Studio 并创建管理员指引

你已启动了 `supabase-auth`、`supabase-db`、`supabase-kong`，但未启动 Studio/Meta（导致 8082 访问失败）。按下列步骤处理：

### 1) 启动 Studio 及依赖
在仓库根目录执行：
```powershell
cd D:\mycode\2026\AutoGPT\autogpt_platform
docker compose -f docker-compose.yml -f db/docker/docker-compose.yml -f db/docker/dev/docker-compose.dev.yml --profile local up -d kong auth db studio meta
```
查看状态：
```powershell
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```
看到 `supabase-studio` 映射 `0.0.0.0:8082->8082/tcp` 即正常。
- 如 8082 被占用，修改 `db/docker/dev/docker-compose.dev.yml` 中 `studio` 的端口映射（如 `18082:8082`），再重新执行上面的 `up -d`。
- 如启动异常，查看日志：`docker logs supabase-studio`、`docker logs supabase-meta`。

### 2) 访问 Studio
浏览器打开 `http://localhost:8082`（或你修改后的端口）。首次访问会要求设置 Studio 管理密码（仅用于 Studio，本身与 Supabase Auth 用户独立）。

### 3) 创建用户并标记为 admin
1. Studio 左侧 **Auth -> Users**，点击 **Add user**，填写邮箱与强密码，勾选 Confirm/Verified。
2. 在 **SQL Editor** 执行（替换为你的邮箱）：
```sql
update auth.users
set role = 'admin',
    raw_app_meta_data = jsonb_set(
      coalesce(raw_app_meta_data, '{}'::jsonb),
      '{role}',
      '"admin"',
      true
    )
where email = 'admin@example.com';
```
执行后重新登录，新的 JWT 将带 `role=admin`。

### 4) 使用管理员账号
- 前端后台入口：登录后访问 `http://localhost:3000/admin` 及子页。
- 直接调用后端管理 API：先用 Supabase Auth 获取 access_token（`/auth/v1/token`），再带 `Authorization: Bearer <token>` 调用（REST 默认 8006，例如 `http://localhost:8006/api/store/admin/listings`）。

### 补充：env file 缺失导致 compose 命令的处理
报错 `env file D:\mycode\2026\.env.default not found` 是因为 `db/docker/docker-compose.yml` 的 `env_file` 写成 `../../.env.default`，从当前目录指向 `D:\mycode\2026\`。解决：
1) 在 `autogpt_platform` 目录执行一次：
```powershell
cd D:\mycode\2026\AutoGPT\autogpt_platform
if (-not (Test-Path ..\.env.default)) { Copy-Item .env.default ..\.env.default }
if (-not (Test-Path ..\.env)) { if (Test-Path .env) { Copy-Item .env ..\.env } }
```
   如需自定义 Supabase 配置，修改 `..\.env`（或 `.env` 后再覆盖）。
2) 重新执行启动命令：
```powershell
docker compose -f docker-compose.yml -f db/docker/docker-compose.yml -f db/docker/dev/docker-compose.dev.yml --profile local up -d kong auth db studio meta
```
3) 再次检查容器与端口映射（8082）。

### 补充说明：为何缺少 .env.default
- `db/docker/docker-compose.yml` 的 `env_file` 指定 `../../.env.default` 和 `../../.env`（指向 `D:\mycode\2026\`）。但 `AutoGPT` 目录已有 `.env`，根目录缺少 `.env.default` 仍会导致 compose 报错。
- 快速修复：
  ```powershell
  cd D:\mycode\2026\AutoGPT\autogpt_platform
  if (-not (Test-Path ..\.env.default)) { Copy-Item .env.default ..\.env.default }
  if (-not (Test-Path ..\.env)) { if (Test-Path .env) { Copy-Item .env ..\.env } }
  ```
  然后重启：
  ```powershell
  docker compose -f docker-compose.yml -f db/docker/docker-compose.yml -f db/docker/dev/docker-compose.dev.yml --profile local up -d kong auth db studio meta
  ```
- 如需自定义配置，可编辑 `..\.env`（或先修改当前目录 `.env` 再覆盖到根目录）。
