# AutoGPT Platform 本地启动指南（中文，非 Docker 启动前后端）

适用场景：你已经把 **Supabase 用 Docker 跑起来了**，但希望 **后端（Python/FastAPI）和前端（Next.js）在本机直接启动**（不使用平台的 Docker 容器）。

> 备注：`autogpt_platform/README.md` 里提到的 `start-local.ps1` / `start-local-windows.cmd` 等脚本在当前仓库中不存在；本文是“手动启动”的等价流程（你记得的 **6/7 个 CMD 窗口**就是这个）。

---

## 1. 端口与服务一览（你会开 7 个窗口）

后端实际是 6 个独立进程（对应 6 个窗口）：

- `ws`（WebSocket）：`8001`
- `executor`（执行器）：`8002`
- `scheduler`（定时/调度）：`8003`
- `db`（Database Manager API）：`8005`
- `rest`（REST API / OpenAPI）：`8006`
- `notification`（通知服务）：`8007`

前端 1 个进程：

- `frontend`（Next.js dev server）：`3000`

你已运行的 Supabase（常见默认）：

- `Kong`（Supabase API Gateway）：`8000`
- `Postgres`：`5432`
- **注意**：Supabase Studio 常见端口 `3000`，会和前端冲突（见“常见问题”）。

---

## 2. 前置条件（Windows/PowerShell）

- Python：`3.10+`（后端 `pyproject.toml` 允许 `>=3.10,<3.14`）
- Poetry：已安装并可用（建议版本 `2.x`）
- Node.js：建议 `22.x`（前端 `autogpt_platform/frontend/package.json` 的 `engines.node` 是 `22.x`）
- Corepack + pnpm：`corepack enable` 后由项目自动管理 pnpm
- 依赖服务：
  - Supabase（你已用 Docker 起）
  - Redis（后端需要）
  - RabbitMQ（后端需要）

> 说明：本文“不用 Docker 启动前后端”，但 Redis/RabbitMQ 你可以本机安装或用 Docker 跑（和 Supabase 一样），二选一即可。

---

## 3. 配置文件准备（必须做）

### 3.1 后端 `.env`

在仓库根目录打开 PowerShell：

```powershell
cd D:\mycode\2026\AutoGPT
Copy-Item autogpt_platform\backend\.env.default autogpt_platform\backend\.env
```

然后编辑 `autogpt_platform/backend/.env`，重点确认这些值：

- `DB_HOST=localhost`
- `DB_PORT=5432`
- `DB_PASS=...`（要能连上你 Supabase 的 Postgres）
- `SUPABASE_URL=http://localhost:8000`
- `SUPABASE_SERVICE_ROLE_KEY=...`（要和 Supabase 的 `SERVICE_ROLE_KEY` 一致）
- `JWT_VERIFY_KEY=...`（要和 Supabase 的 `JWT_SECRET` 一致）
- **建议**：`PLATFORM_BASE_URL=http://localhost:8006`（用于 webhook 等场景；不用 webhook 也可先不管）
- `FRONTEND_BASE_URL=http://localhost:3000`

从哪里拿 Supabase 的 key？

- 如果你是用本仓库的 Supabase 配置起的（`autogpt_platform/.env`），那：
  - Supabase：`JWT_SECRET` → 后端：`JWT_VERIFY_KEY`
  - Supabase：`SERVICE_ROLE_KEY` → 后端：`SUPABASE_SERVICE_ROLE_KEY`
  - Supabase：`ANON_KEY` → 前端：`NEXT_PUBLIC_SUPABASE_ANON_KEY`
- 如果你用的是其它方式起的 Supabase：去你的 Supabase 配置/控制台里拿到对应的 JWT secret / keys。

### 3.2 前端 `.env`

```powershell
Copy-Item autogpt_platform\frontend\.env.default autogpt_platform\frontend\.env
```

编辑 `autogpt_platform/frontend/.env`，重点确认：

- `NEXT_PUBLIC_SUPABASE_URL=http://localhost:8000`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY=...`（和 Supabase 的 `ANON_KEY` 一致）
- `NEXT_PUBLIC_AGPT_SERVER_URL=http://localhost:8006/api`
- `NEXT_PUBLIC_AGPT_WS_SERVER_URL=ws://localhost:8001/ws`
- `NEXT_PUBLIC_FRONTEND_BASE_URL=http://localhost:3000`

---

## 4. 安装依赖（首次必做）

### 4.1 后端依赖（Poetry）

```powershell
cd D:\mycode\2026\AutoGPT\autogpt_platform\backend
poetry install
```

### 4.2 前端依赖（pnpm）

```powershell
cd D:\mycode\2026\AutoGPT\autogpt_platform\frontend
corepack enable
pnpm i
```

---

## 5. 数据库迁移（首次/更新后必做）

后端使用 Prisma 管理 schema（会建/更新 `platform` schema 等）：

```powershell
cd D:\mycode\2026\AutoGPT\autogpt_platform\backend
poetry run prisma generate
poetry run prisma migrate deploy
```

---

## 6. 启动后端（6 个窗口）

请先确保：Supabase（含 Postgres）/ Redis / RabbitMQ 都已在运行。

打开 6 个 PowerShell/CMD 窗口，每个窗口都先进入目录：

```powershell
cd D:\mycode\2026\AutoGPT\autogpt_platform\backend
```

然后分别运行（推荐顺序）：

1) Database Manager（8005）

```powershell
poetry run db
```

2) WebSocket（8001）

```powershell
poetry run ws
```

3) Notification（8007）

```powershell
poetry run notification
```

4) Scheduler（8003）

```powershell
poetry run scheduler
```

5) Executor（8002）

```powershell
poetry run executor
```

6) REST API（8006）

```powershell
poetry run rest
```

> 小提示：前端启动时会强制拉取 OpenAPI（`pnpm dev` 会跑 `generate:api:force`），所以 **`rest` 必须先起来**。

---

## 7. 启动前端（第 7 个窗口）

打开第 7 个窗口：

```powershell
cd D:\mycode\2026\AutoGPT\autogpt_platform\frontend
pnpm dev
```

启动成功后访问：

- 前端：`http://localhost:3000`
- 后端 Swagger：`http://localhost:8006/docs`

---

## 8. 更省窗口的启动方式（可选）

如果你不想开 6 个后端窗口，可以用一个窗口一次启动所有后端进程：

```powershell
cd D:\mycode\2026\AutoGPT\autogpt_platform\backend
poetry run app
```

此时你只需要 2 个窗口：一个跑后端 `poetry run app`，一个跑前端 `pnpm dev`。

---

## 9. 常见问题排查

### 9.1 `3000` 端口被占用

最常见原因：Supabase Studio 也在用 `3000`。

- 解决思路 A：停掉/不启动 Studio 容器
- 解决思路 B：把 Supabase Studio 改到别的端口（例如 `3001`）后重启
- 解决思路 C：让 Next.js 选择 `3001`（它会提示），同时把：
  - `autogpt_platform/backend/.env` 的 `FRONTEND_BASE_URL`
  - `autogpt_platform/frontend/.env` 的 `NEXT_PUBLIC_FRONTEND_BASE_URL`
  都改成 `http://localhost:3001`

### 9.2 前端卡在 `generate:api:force` / 拉 OpenAPI 失败

`pnpm dev` 会访问：`http://localhost:8006/openapi.json`

- 先确认 `poetry run rest` 已启动且 `http://localhost:8006/docs` 能打开
- 如果报 `curl` 找不到：确保系统里有 `curl.exe`（Windows 10/11 通常自带）

### 9.3 后端连不上数据库（`5432` / 认证失败）

- 确认 Supabase Postgres 映射到本机 `5432`
- 检查 `autogpt_platform/backend/.env`：
  - `DB_HOST / DB_PORT / DB_USER / DB_PASS`
  - `DB_SCHEMA=platform`（迁移会建 schema；没跑迁移会报错）

### 9.4 登录/鉴权异常（JWT 相关）

- 必须保证：
  - 后端 `JWT_VERIFY_KEY` == Supabase `JWT_SECRET`
  - 前端 `NEXT_PUBLIC_SUPABASE_ANON_KEY` == Supabase `ANON_KEY`
  - 后端 `SUPABASE_SERVICE_ROLE_KEY` == Supabase `SERVICE_ROLE_KEY`

### 9.5 RabbitMQ / Redis 连接失败

- RabbitMQ：检查 `RABBITMQ_HOST/RABBITMQ_PORT` 以及 `RABBITMQ_DEFAULT_USER/RABBITMQ_DEFAULT_PASS`
- Redis：检查 `REDIS_HOST/REDIS_PORT`（有密码再配 `REDIS_PASSWORD`）

### 9.6 `invalid PYTHONUTF8 environment variable value`

Windows 环境变量 `PYTHONUTF8` 只能是 `0` 或 `1`。你可以：

- 直接删除该环境变量，或
- 设置为 `1` 后重新打开终端再启动服务。

